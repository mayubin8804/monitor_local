#!/usr/bin/python
# -*- coding: UTF-8 -*-

import os
import sys
import glob
import subprocess
import logging
import persistent
from ZODB import FileStorage, DB
from BTrees.OOBTree import OOBTree
import transaction

logging.getLogger('ZODB.FileStorage')
logging.getLogger('zc.lockfile')

class MyZODB(object):
    def __init__(self, dbPath):
        self.__dbPath = dbPath
        self.__logger = logging.getLogger('monitor_local.MyProjectDB.MyZODB')
        self.__logger.info("Open database: %s", self.__dbPath)
        self.__storage = FileStorage.FileStorage(self.__dbPath)
        self.__db = DB(self.__storage)
        self.__conn = self.__db.open()
        self.__dbroot = self.__conn.root()
        self.__openFlag = True
    
    def addItem(self, itemName, itemObj):
        if not self.__dbroot.has_key(itemName):
            self.__dbroot[itemName] = itemObj
        return self.__dbroot[itemName]
    
    def commit(self):
        transaction.commit()
    
    def close(self):
        self.__logger.info("Close database: %s", self.__dbPath)
        self.__conn.close()
        self.__db.close()
        self.__storage.close()
        self.__openFlag = False
    
    def removeDBFile(self):
        self.__logger.info("Remove database: %s", self.__dbPath)
        if self.__openFlag:
            self.close()
        for suffix in ('', '.index', '.lock', '.tmp'):
            dbFile = self.__dbPath + suffix
            if os.path.isfile(dbFile):
                os.remove(dbFile)

class MyJob(persistent.Persistent):
    '''This class represents a single job.'''
    
    def __init__(self, script):
        self.__script = script
        self.__pid = ''       # pid: un-running = '', running = pid
        self.__status = 0     # status: 0-not started, 1-running but not finished, 2-finished.
        self.__retriedTimes = 0
        self.__dependent = persistent.list.PersistentList()
        self.__stdoutFile = self.__script + '.o'
        self.__stderrFile = self.__script + '.e'
        self.__finishFile = self.__script + '.sign'
    
    def addDependent(self, job):
        self.__dependent.append(job)
    
    def run(self):
        fh_o = open(self.__stdoutFile, 'w')
        fh_e = open(self.__stderrFile, 'w')
        job = self.__script + ';echo finish > ' + self.__finishFile
        p = subprocess.Popen(job, stdout=fh_o, stderr=fh_e, shell=True)
        self.__pid = p.pid
        self.__status = 1
    
    def getStatus(self):
        return self.__status
    
    def updateStatus(self):
        if self.__pid != '':
            if os.path.isfile(self.__finishFile):
                self.__status = 2

class MyProjectDB(object):
    def __init__(self, prjName, prjDBFile):
        self.__logger = logging.getLogger('monitor_local.MyProjectDB')
        self.__myZODBObj   = MyZODB(prjDBFile)
        self.__projectName = self.__myZODBObj.addItem('projectName', prjName)
        self.__maxJobNum   = self.__myZODBObj.addItem('maxJobNum', 10)
        self.__currentJobs = self.__myZODBObj.addItem('currentJobs', 0)
        self.__allFinishedFlag = self.__myZODBObj.addItem('allFinishedFlag', False)
        self.__jobDic      = self.__myZODBObj.addItem('jobs', OOBTree())
    
    def setMaxJobNum(self, maxJobNum):
        self.__maxJobNum = maxJobNum
        self.__myZODBObj.commit()
    
    def importQsubsge(self, jobListFile, addMode, jobSplitNum=1):
        self.__logger.info("Importing tasks of qsubsge format into project db: %s", jobListFile)
        jobList = self.__splitQsubsgeJob(jobListFile, jobSplitNum)
        prevJobList = self.__jobDic.keys()
        totalJobNum = 0
        addJobNum   = 0
        for job in jobList:
            totalJobNum += 1
            if job in self.__jobDic:
                continue
            # new job
            addJobNum += 1
            jobObj = MyJob(job)
            if addMode == 1:
                for prevJob in prevJobList:
                    jobObj.addDependent(prevJob)
            self.__jobDic[job] = jobObj
        self.__logger.info("Finish importing tasks. Total job number: %d, added job number: %d", totalJobNum, addJobNum)
        self.__myZODBObj.commit()
    
    def importPymonitor(self, jobListFile, addMode=0):
        self.__logger.info("Importing tasks of pymonitor format into project db: %s", jobListFile)
        totalJobNum = 0
        addJobNum   = 0
        with open(jobListFile, 'r') as fh:
            for line in fh:
                jobStrList = line.strip().split()
                firstJob = ''
                secondJob = ''
                for jobStr in jobStrList:
                    totalJobNum += 1
                    job = jobStr.split(':')[0]
                    if firstJob == '':
                        firstJob = job
                    else:
                        secondJob = job
                    if job in self.__jobDic:
                        continue
                    else:
                        # new job
                        addJobNum += 1
                        jobObj = MyJob(job)
                        self.__jobDic[job] = jobObj
                if secondJob != '':
                    self.__jobDic[secondJob].addDependent(firstJob)
        self.__logger.info("Finish importing tasks. Total job number: %d, added job number: %d", totalJobNum, addJobNum)
        self.__myZODBObj.commit()
    
    def close(self):
        self.__myZODBObj.close()
    
    def removeDB(self):
        self.__myZODBObj.removeDBFile()
    
    def __splitQsubsgeJob(self, taskListFile, jobSplitNum=1):
        taskDir = "%s.%s.qsub" % (taskListFile, os.getpid())
        os.mkdir(taskDir)
        taskNo = 1
        lineNo = 0
        oneTask = ''
        taskList = []
        with open(taskListFile, 'r') as fh_list:
            for line in fh_list:
                lineNo += 1
                oneTask += line
                if lineNo % jobSplitNum == 0:
                    taskScript = os.path.join(taskDir, "task_%d.sh" % taskNo)
                    taskList.append(taskScript)
                    with open(taskScript, 'w') as fh_task:
                        fh_task.write(oneTask)
                    oneTask = ''
                    taskNo += 1
        return taskList

if __name__ == '__main__':
    with open('./job.list', 'w') as fh:
        for i in range(6):
            fh.write('echo %d\n' % i)
    myProjectDBObj = MyProjectDB('test', './test.db')
    myProjectDBObj.importQsubsge('./job.list', 0, 3)
    myProjectDBObj.close()
    #removeDBFile('./test.db')